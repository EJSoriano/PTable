package Connection;

import java.io.Serializable;
import java.sql.PreparedStatement;
import javax.inject.Named;
import java.util.Random;
import java.sql.*;
import javax.enterprise.context.SessionScoped;

@Named(value = "function")
@SessionScoped
public class FunctionalityBean implements Serializable {

    private Connection conn;

    public FunctionalityBean(Connection conn) {
        this.conn = conn;
    }

    public void setConnecction(Connection conn) {
        this.conn = conn;
    }

    //Creates an admin.
    public void createUser(String first, String last, String user, String pass) {
        try {
            String query = "{call sp_createUser(?, ?, ?, ?, ?)}";
            PreparedStatement stmt = conn.prepareStatement(query);
            stmt.setString(1, first);
            stmt.setString(2, last);
            stmt.setString(3, user);
            stmt.setString(4, pass);
            stmt.setInt(5, 1);

            stmt.execute();
            //System.out.println("User " + first + " " + last + " was created.");
        } catch (Exception e) {
        }
    }

    //Validates a user login. Returns true if valid, false if not.
    public boolean validateUser(String user, String pass) {
        try {
            String query = "{call sp_validateUser(?, ?)}";

            PreparedStatement stmt = conn.prepareStatement(query);
            stmt.setString(1, user);
            stmt.setString(2, pass);

            ResultSet rs = stmt.executeQuery();

            while (rs.next()) {
                int valid = rs.getInt("count(*)");
                if (valid == 1) {
                    System.out.println("User Validated");
                    return true;
                } else {
                    System.out.println("User Not Validated");
                    return false;
                }
            }
        } catch (SQLException e) {
        }
        return false;
    }

    //Adds an element to the database.
    public void insertElement(String elemName, String atomSymb, String atomNum, String mass, String group, int period, String state25,
            String valences, String elecConf, String density, String series, int xCor, int yCor) {
        Random rand = new Random();
        int n = rand.nextInt(999) + 150;
        int atomNumInt = 1000;
        int corDefault = 1;
        if (!atomNum.isEmpty()) {
            atomNumInt = Integer.parseInt(atomNum);
        }
        if (elemName.isEmpty()) {
            elemName = "Element " + atomNumInt;
        }
        if (atomSymb.isEmpty()) {
            atomSymb = "XX";
        }
        if (density.isEmpty()) {
            density = "";
        }
        if (group.isEmpty()) {
            group = "";
        }
        if (xCor == 0) {
            xCor = corDefault;
        }
        if (yCor == 0) {
            yCor = corDefault;
        }

        try {
            String query = "{call sp_insertelement(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)}";
            PreparedStatement stmt = conn.prepareStatement(query);
            stmt.setInt(1, atomNumInt);
            stmt.setString(2, atomSymb);
            stmt.setString(3, elemName);
            stmt.setString(4, mass);
            stmt.setString(5, group);
            stmt.setInt(6, period);
            stmt.setString(7, density);
            stmt.setString(8, series);
            stmt.setString(9, state25);
            stmt.setString(10, valences);
            stmt.setString(11, elecConf);
            stmt.setInt(12, xCor);
            stmt.setInt(13, yCor);

            stmt.execute();
            System.out.println("Element " + elemName + " was added.");
        } catch (Exception e) {
        }
    }

    //Deletes an element given the atomic number.
    public void deleteElement(String atomNum) {
        int atomNumInt = 0;
        if (!atomNum.isEmpty()) {
            atomNumInt = Integer.parseInt(atomNum);
        }
        try {
            String query = "{call sp_deleteelement_(?)}";
            PreparedStatement stmt = conn.prepareStatement(query);
            stmt.setInt(1, atomNumInt);
            stmt.execute();
            System.out.println("Element " + atomNum + " was deleted.");
        } catch (Exception e) {
        }
    }

    //Updates an element. Update form must contain ALL data, even unedited data. Use object getters to fill the form upon generation.
    public void updateElement(String elemName, String atomSymb, String atomNum, String mass, String group, int period, String state25,
            String valences, String elecConf, String density, String series, int xCor, int yCor) {
        deleteElement(atomNum);
        insertElement(elemName, atomSymb, atomNum, mass, group, period, state25, valences, elecConf, density, series, xCor, yCor);
    }

    public void insertIsotope(int atomNum, String isoName, int isoNum, String isoSymb, float isoMass, String isoComp, String isoWeight, String abundance) {
        int atomNumInt = 1000;
        float atomNumFloat = 0f;
        float isoNumFloat = 0f;
        String mass = "";
        Random rand = new Random();
        int n = rand.nextInt(999) + 500;
        String symbol = ("Unnamed Isotope " + n);
        String nothing = null;

        if (!Integer.toBinaryString(atomNum).equals("")) {
            atomNumFloat = (float) atomNum;
        }
        if (!Integer.toBinaryString(isoNum).equals("")) {
            isoNumFloat = (float) isoNum;
        }
        if (isoSymb.isEmpty()) {
            isoSymb = symbol;
        }
        if (!String.valueOf(isoMass).isEmpty()) {
            mass = String.valueOf(isoMass);
        }

        try {
            String query = "{call sp_insertisotope(?, ?, ?, ?, ?, ?, ?, ?, ?, ?)}";
            PreparedStatement stmt = conn.prepareStatement(query);
            stmt.setFloat(1, atomNumFloat);
            stmt.setString(2, nothing);
            stmt.setString(3, isoName);
            stmt.setFloat(4, isoNumFloat);
            stmt.setString(5, isoSymb);
            stmt.setString(6, mass);
            stmt.setString(7, isoComp);
            stmt.setString(8, isoWeight);
            stmt.setString(9, nothing);
            stmt.setString(10, abundance);

            stmt.execute();
            System.out.println("Isotope " + isoSymb + " was added.");
        } catch (Exception e) {
        }
    }

    //Deletes an isotope given the isotopic symbol
    public void deleteIsotope(String isoSymb) {
        try {
            String query = "{call sp_deleteisotope(?)}";
            PreparedStatement stmt = conn.prepareStatement(query);
            stmt.setString(1, isoSymb);
            stmt.execute();
            System.out.println("Isotope " + isoSymb + " was deleted.");
        } catch (Exception e) {
        }
    }

    //Updates an isotope. Update form must contain ALL data, even unedited data. Use object getters to fill the form upon generation.
    public void updateIsotope(int atomNum, String isoName, int isoNum, String isoSymb, float isoMass, String isoComp, String isoWeight, String abundance) {
        deleteIsotope(isoSymb);
        insertIsotope(atomNum, isoName, isoNum, isoSymb, isoMass, isoComp, isoWeight, abundance);
        System.out.println("Isotope " + isoSymb + " was updated.");
    }
}
